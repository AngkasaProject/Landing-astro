---
import AdminLayout from '../../layouts/AdminLayout.astro';
import '../../styles/global.css';
---

<AdminLayout title="Upload Produk Baru">
  <div class="mx-auto max-w-4xl p-6">
    <div class="rounded-2xl border border-slate-200 bg-white p-8 shadow-sm">
      <div class="mb-6 flex items-center justify-between">
        <h1 class="text-2xl font-bold text-slate-800">Informasi Produk Jersey</h1>
        <a href="/admin/dashboard" class="text-sm font-medium text-slate-500 hover:text-slate-800">
          <i class="fa-solid fa-arrow-left"></i> Kembali
        </a>
      </div>

      <form id="upload-form" class="space-y-6">
        <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
          <div class="md:col-span-2">
            <label class="mb-2 block text-sm font-semibold text-slate-700">Nama Jersey</label>
            <input
              name="name"
              type="text"
              required
              class="w-full rounded-xl border border-slate-300 px-4 py-2.5 transition outline-none focus:ring-2 focus:ring-lime-500"
              placeholder="Misal: Atasan Pola Standar"
            />
          </div>

          <div class="md:col-span-2">
            <label class="mb-2 block text-sm font-semibold text-slate-700">Deskripsi Produk</label>
            <textarea
              name="description"
              rows="4"
              required
              class="w-full rounded-xl border border-slate-300 px-4 py-2.5 transition outline-none focus:ring-2 focus:ring-lime-500"
              placeholder="Jelaskan detail bahan (Dryfit/Milano), ukuran, dan keunggulan jersey..."
            ></textarea>
          </div>

          <div>
            <label class="mb-2 block text-sm font-semibold text-slate-700">Harga Utama (Rp)</label>
            <input
              name="price"
              type="number"
              required
              class="w-full rounded-xl border border-slate-300 px-4 py-2.5 transition outline-none focus:ring-2 focus:ring-lime-500"
              placeholder="110000"
            />
          </div>

          <div>
            <label class="mb-2 block text-sm font-semibold text-slate-700">Harga Coret (Rp)</label>
            <input
              name="old_price"
              type="number"
              class="w-full rounded-xl border border-slate-300 px-4 py-2.5 transition outline-none focus:ring-2 focus:ring-lime-500"
              placeholder="150000"
            />
          </div>

          <div class="md:col-span-2">
            <label class="mb-2 block text-sm font-semibold text-slate-700">Kategori</label>
            <select
              name="category"
              class="w-full rounded-xl border border-slate-300 px-4 py-2.5 transition outline-none focus:ring-2 focus:ring-lime-500"
            >
              <option>Jersey Standar</option>
              <option>Jersey Setelan</option>
              <option>Jersey Vintage</option>
            </select>
          </div>

          <div class="md:col-span-2">
            <label class="mb-2 block text-sm font-semibold text-slate-700">Upload Foto Produk</label
            >
            <div
              class="relative cursor-pointer rounded-2xl border-2 border-dashed border-slate-300 bg-slate-50 p-8 text-center transition hover:border-lime-500"
            >
              <input
                type="file"
                id="image-input"
                multiple
                accept="image/*"
                class="absolute inset-0 cursor-pointer opacity-0"
              />
              <div class="space-y-2">
                <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400"></i>
                <p class="text-sm text-slate-600">Klik atau tarik gambar ke sini</p>
                <p class="text-xs text-slate-400">PNG, JPG up to 5MB</p>
              </div>
            </div>
            <div id="preview-container" class="mt-4 grid grid-cols-4 gap-4"></div>
          </div>
        </div>

        <button
          type="submit"
          id="submit-btn"
          class="w-full rounded-xl bg-lime-600 py-4 font-bold text-white shadow-lg shadow-lime-600/20 transition hover:bg-lime-700 active:scale-[0.98]"
        >
          <i class="fa-solid fa-paper-plane mr-2"></i> Simpan ke Database
        </button>
      </form>
    </div>
  </div>

  <script>
    import { supabase } from '../../lib/supabase';
    import Swal from 'sweetalert2';

    const form = document.getElementById('upload-form') as HTMLFormElement;
    const imageInput = document.getElementById('image-input') as HTMLInputElement;
    const previewContainer = document.getElementById('preview-container');

    // Preview Gambar
    imageInput?.addEventListener('change', () => {
      if (previewContainer) previewContainer.innerHTML = '';
      const files = Array.from(imageInput.files || []);
      files.forEach((file) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const div = document.createElement('div');
          div.className = 'relative aspect-square';
          div.innerHTML = `<img src="${e.target?.result}" class="h-full w-full object-cover rounded-lg border shadow-sm" />`;
          previewContainer?.appendChild(div);
        };
        reader.readAsDataURL(file);
      });
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('submit-btn') as HTMLButtonElement;

      const formData = new FormData(form);
      const files = imageInput.files;

      try {
        if (!files || files.length === 0) {
          throw new Error('Harap pilih minimal satu gambar produk!');
        }

        // Tampilkan Loading
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Memproses...';

        const uploadedImages = [];

        // Upload loop
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const fileExt = file.name.split('.').pop();
          const fileName = `${Date.now()}-${i}.${fileExt}`;
          const filePath = `products/${fileName}`;

          const { error: uploadError } = await supabase.storage
            .from('jersey-images')
            .upload(filePath, file);

          if (uploadError) throw uploadError;

          const {
            data: { publicUrl },
          } = supabase.storage.from('jersey-images').getPublicUrl(filePath);
          uploadedImages.push({ thumb: publicUrl, full: publicUrl });
        }

        // Simpan ke Database
        const { error: dbError } = await supabase.from('products').insert([
          {
            name: formData.get('name'),
            description: formData.get('description'),
            price: parseInt(formData.get('price') as string),
            old_price: formData.get('old_price')
              ? parseInt(formData.get('old_price') as string)
              : null,
            category: formData.get('category'),
            image_src: uploadedImages[0].full,
            images: uploadedImages,
            is_new: true,
            rating: 5.0,
          },
        ]);

        if (dbError) throw dbError;

        // Notifikasi Sukses ala Edit
        await Swal.fire({
          icon: 'success',
          title: 'Produk Berhasil Disimpan!',
          text: 'Jersey baru telah ditambahkan ke database.',
          confirmButtonColor: '#65a30d',
        });

        window.location.href = '/admin/dashboard';
      } catch (err: any) {
        Swal.fire({
          icon: 'error',
          title: 'Waduh!',
          text: err.message,
          confirmButtonColor: '#ef4444',
        });
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-paper-plane mr-2"></i> Simpan ke Database';
      }
    });
  </script>
</AdminLayout>
